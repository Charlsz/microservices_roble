<!DOCTYPE html>
<html>
<head>
    <title>Microservices Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .service-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .status-active { background-color: #28a745; }
        .status-down { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Microservices Dashboard</h1>
        
        <!-- Login Form -->
        <div id="loginForm" class="card p-3 mb-4">
            <h3>Login</h3>
            <input type="email" id="email" placeholder="Email" class="form-control mb-2">
            <input type="password" id="password" placeholder="Password" class="form-control mb-2">
            <button onclick="login()" class="btn btn-primary">Login</button>
        </div>

        <!-- Services Management -->
        <div id="servicesPanel" style="display:none">
            <div class="row mb-4">
                <div class="col">
                    <h3>Active Services</h3>
                    <div id="servicesList" class="list-group"></div>
                </div>
            </div>

            <!-- New Service Form -->
            <div class="card p-3 mb-4">
                <h3>Register New Service</h3>
                <input type="text" id="serviceName" placeholder="Service Name" class="form-control mb-2">
                <input type="number" id="servicePort" placeholder="Port" class="form-control mb-2">
                <select id="serviceType" class="form-control mb-2">
                    <option value="">Select Type</option>
                    <option value="user">User Service</option>
                    <option value="product">Product Service</option>
                    <option value="custom">Custom Service</option>
                </select>
                <textarea id="serviceDescription" placeholder="Description" class="form-control mb-2"></textarea>
                <button onclick="registerService()" class="btn btn-success">Register Service</button>
            </div>

            <!-- Test Endpoint Section -->
            <div class="card p-3">
                <h3>Test Endpoint</h3>
                <select id="testService" class="form-control mb-2"></select>
                <input type="text" id="testEndpoint" placeholder="/endpoint-path" class="form-control mb-2">
                <select id="testMethod" class="form-control mb-2">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <textarea id="testParams" placeholder="Parameters (JSON)" class="form-control mb-2"></textarea>
                <button onclick="testEndpoint()" class="btn btn-primary">Test</button>
                <div id="testResult" class="mt-2"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;

        // Service monitoring
        function updateServicesList() {
            fetch('/services/status', {
                headers: {
                    'x-user-email': currentUser.email,
                    'Authorization': `Bearer ${currentUser.accessToken}`
                }
            })
            .then(res => res.json())
            .then(services => {
                const list = document.getElementById('servicesList');
                const testSelect = document.getElementById('testService');
                
                list.innerHTML = services.map(service => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="service-status status-${service.status}"></span>
                                <strong>${service.name}</strong> (${service.type})
                            </div>
                            <div>
                                <button onclick="editService('${service.name}')" class="btn btn-sm btn-primary">Edit</button>
                                <button onclick="deleteService('${service.name}')" class="btn btn-sm btn-danger">Delete</button>
                            </div>
                        </div>
                        <p class="mb-1">${service.description}</p>
                        <small>Port: ${service.port}</small>
                    </div>
                `).join('');

                // Update test endpoint dropdown
                testSelect.innerHTML = services.map(service => 
                    `<option value="${service.name}">${service.name}</option>`
                ).join('');
            });
        }

        // Register new service
        async function registerService() {
            const service = {
                name: document.getElementById('serviceName').value,
                port: document.getElementById('servicePort').value,
                type: document.getElementById('serviceType').value,
                description: document.getElementById('serviceDescription').value
            };

            try {
                await fetch('/services', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-email': currentUser.email,
                        'Authorization': `Bearer ${currentUser.accessToken}`
                    },
                    body: JSON.stringify(service)
                });
                updateServicesList();
                clearServiceForm();
            } catch (error) {
                alert('Error registering service: ' + error);
            }
        }

        // Test endpoint
        async function testEndpoint() {
            const serviceName = document.getElementById('testService').value;
            const endpoint = document.getElementById('testEndpoint').value;
            const method = document.getElementById('testMethod').value;
            const params = document.getElementById('testParams').value;

            try {
                const response = await fetch('/services/test-endpoint', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-email': currentUser.email,
                        'Authorization': `Bearer ${currentUser.accessToken}`
                    },
                    body: JSON.stringify({
                        serviceName,
                        endpoint,
                        method,
                        params: params ? JSON.parse(params) : {}
                    })
                });

                const result = await response.json();
                document.getElementById('testResult').innerHTML = `
                    <pre class="bg-light p-2">
                        ${JSON.stringify(result, null, 2)}
                    </pre>
                `;
            } catch (error) {
                document.getElementById('testResult').innerHTML = `
                    <div class="alert alert-danger">
                        ${error.message}
                    </div>
                `;
            }
        }

        // Clear form
        function clearServiceForm() {
            document.getElementById('serviceName').value = '';
            document.getElementById('servicePort').value = '';
            document.getElementById('serviceType').value = '';
            document.getElementById('serviceDescription').value = '';
        }

        // Start monitoring when logged in
        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                if (response.ok) {
                    currentUser = { email, ...data };
                    document.getElementById('loginForm').style.display = 'none';
                    document.getElementById('servicesPanel').style.display = 'block';
                    updateServicesList();
                    setInterval(updateServicesList, 30000); // Update every 30 seconds
                }
            } catch (error) {
                alert('Error in login: ' + error);
            }
        }

        async function deleteService(name) {
            try {
                await fetch(`/microservices/${name}`, {
                    method: 'DELETE',
                    headers: {
                        'x-user-email': currentUser.email,
                        'Authorization': `Bearer ${currentUser.accessToken}`
                    }
                });
                updateServicesList();
            } catch (error) {
                alert('Error deleting service: ' + error);
            }
        }
    </script>
</body>
</html>